from typing import Dict, List, Set, Any

from app.core.models.position import Position

class PortfolioState:
    """
    Класс-хранилище, инкапсулирующий все динамическое состояние портфеля.

    Этот объект не содержит бизнес-логики. Его единственная задача — быть
    единым источником правды о текущем капитале, позициях и сделках.
    Сервисы (RiskMonitor, OrderManager, FillProcessor) будут получать этот
    объект и модифицировать его.
    """

    def __init__(self, initial_capital: float):
        """
        Инициализирует состояние портфеля.

        :param initial_capital: Начальный капитал для симуляции или торговли.
        """
        # --- Финансовое состояние ---
        self.initial_capital: float = initial_capital
        """Начальный капитал, не изменяется в ходе работы."""

        self.current_capital: float = initial_capital
        """Текущий капитал, обновляется после каждой закрытой сделки."""

        # --- Состояние позиций и ордеров ---
        self.positions: Dict[str, Position] = {}
        """
        Словарь для хранения всех активных позиций.
        Ключ - тикер инструмента (str), значение - объект Position.
        """

        self.pending_orders: Set[str] = set()
        """
        Множество (set) для хранения тикеров инструментов, по которым был
        отправлен ордер, но еще не пришел отчет об исполнении (FillEvent).
        Это критически важный механизм для предотвращения отправки дублирующих
        ордеров по одному и тому же инструменту.
        """

        # --- История ---
        self.closed_trades: List[Dict[str, Any]] = []
        """
        Список словарей, содержащий информацию о всех закрытых сделках
        для финального отчета.
        """