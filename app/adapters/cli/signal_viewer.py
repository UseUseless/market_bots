"""
–ú–æ–¥—É–ª—å –∫–æ–Ω—Å–æ–ª—å–Ω–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ (CLI Output Adapter).

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `SignalHandler` –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤
–Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤—ã–≤–æ–¥ (stdout) —Ç–µ—Ä–º–∏–Ω–∞–ª–∞. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç ANSI-–∫–æ–¥—ã
–¥–ª—è —Ü–≤–µ—Ç–æ–≤–æ–π –ø–æ–¥—Å–≤–µ—Ç–∫–∏ (–∑–µ–ª–µ–Ω—ã–π –¥–ª—è –ø–æ–∫—É–ø–∫–∏, –∫—Ä–∞—Å–Ω—ã–π –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏).

–†–æ–ª—å –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:
    Secondary (Driven) Adapter. –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —è–¥—Ä–∞ –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
"""

from datetime import datetime

from app.shared.interfaces import SignalHandler
from app.shared.events import SignalEvent
from app.shared.types import TradeDirection


class ConsoleSignalViewer(SignalHandler):
    """
    –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏.

    –í—ã–≤–æ–¥–∏—Ç –∫—Ä–∞—Å–∏–≤–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–∏–≥–Ω–∞–ª–∞.
    –ü–æ–ª–µ–∑–µ–Ω –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Telegram.
    """

    async def handle_signal(self, event: SignalEvent) -> None:
        """
        –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ —Å–∏–≥–Ω–∞–ª–∞ –∏ –≤—ã–≤–æ–¥–∏—Ç –µ–≥–æ –≤ –∫–æ–Ω—Å–æ–ª—å.

        –ú–µ—Ç–æ–¥ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ü–≤–µ—Ç –≤—ã–≤–æ–¥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–¥–µ–ª–∫–∏ (BUY/SELL)
        –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≤–∏–¥–µ —á–∏—Ç–∞–µ–º–æ–≥–æ –±–ª–æ–∫–∞ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏.

        Args:
            event (SignalEvent): –°–æ–±—ã—Ç–∏–µ —Å–∏–≥–Ω–∞–ª–∞, —Å–æ–¥–µ—Ä–∂–∞—â–µ–µ –¥–∞–Ω–Ω—ã–µ –æ —Ü–µ–Ω–µ,
                –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ, —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –≤—Ä–µ–º–µ–Ω–∏.
        """
        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        if event.direction == TradeDirection.BUY:
            # ANSI escape code –¥–ª—è —è—Ä–∫–æ-–∑–µ–ª–µ–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
            icon, color_code = "üü¢ BUY ", "\033[92m"
        else:
            # ANSI escape code –¥–ª—è —è—Ä–∫–æ-–∫—Ä–∞—Å–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
            icon, color_code = "üî¥ SELL", "\033[91m"

        # –ö–æ–¥ –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ü–≤–µ—Ç–∞ –≤ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π
        reset_code = "\033[0m"

        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã
        price_str = f"{event.price:.4f}"

        # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–æ–±—ã—Ç–∏—è)
        time_str = str(event.timestamp)

        # –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞
        print("\n" + "=" * 50)
        print(f"{color_code} {icon} | {event.instrument} | {event.strategy_name} {reset_code}")
        print(f" üíµ Price: {price_str}")
        print(f" üïí Time:  {time_str}")
        print("=" * 50 + "\n")