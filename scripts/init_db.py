"""
–°–∫—Ä–∏–ø—Ç –ø–µ—Ä–≤–∏—á–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö –≤ SQLAlchemy –º–æ–¥–µ–ª—è—Ö (`app.infrastructure.database.models`).
–¢–∞–∫–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–∑—ã —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (Seed Data), –µ—Å–ª–∏ –æ–Ω–∞ –ø—É—Å—Ç–∞,
–¥–æ–±–∞–≤–ª—è—è –¥–µ—Ñ–æ–ª—Ç–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã.

–ó–∞–ø—É—Å–∫:
    python scripts/init_db.py
"""

import asyncio
import sys

from app.infrastructure.database.session import init_models, async_session_factory
from app.infrastructure.database.repositories import ConfigRepository


async def main() -> None:
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ç–æ—Ä–∞.

    –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:
    1. –í—ã–∑—ã–≤–∞–µ—Ç `init_models()` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü (–∞–Ω–∞–ª–æ–≥ CREATE TABLE IF NOT EXISTS).
    2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —á–µ—Ä–µ–∑ `ConfigRepository`.
    3. –ï—Å–ª–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é (Bybit/BTCUSDT/1min),
       —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ —Å—Ä–∞–∑—É –∑–∞–ø—É—Å—Ç–∏—Ç—å Live Monitor –±–µ–∑ —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
    """
    print("üöÄ –ù–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...")

    # 1. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã –ë–î
    await init_models()
    print("‚úÖ –¢–∞–±–ª–∏—Ü—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã (–∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏).")

    # 2. –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (Seeding)
    async with async_session_factory() as session:
        repo = ConfigRepository(session)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—É—Å—Ç–∞—è –ª–∏ –±–∞–∑–∞ (–≤ –ø–ª–∞–Ω–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π)
        existing = await repo.get_active_strategies()

        if not existing:
            print("üì¶ –ë–∞–∑–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é...")

            # –î–æ–±–∞–≤–ª—è–µ–º "–±–µ—Å—Ö–æ–∑–Ω—É—é" —Å—Ç—Ä–∞—Ç–µ–≥–∏—é (–±–µ–∑ –±–æ—Ç–∞), –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –±—É–¥–µ—Ç
            # –ø—Ä–∏–≤—è–∑–∞—Ç—å –ø–æ–∑–∂–µ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ç–µ—Å—Ç–æ–≤.
            await repo.add_strategy_config({
                "exchange": "bybit",
                "instrument": "BTCUSDT",
                "interval": "1min",
                "strategy_name": "live_debug_strategy",
                "risk_manager_type": "FIXED",
                "parameters": {},
                "is_active": True
            })
            print("‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è 'live_debug_strategy' –¥–æ–±–∞–≤–ª–µ–Ω–∞.")
        else:
            print("‚ÑπÔ∏è –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç. –ü—Ä–æ–ø—É—Å–∫ —à–∞–≥–∞ –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è.")

    print("üèÅ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")


if __name__ == "__main__":
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Event Loop –¥–ª—è Windows (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è Python 3.8+ –Ω–∞ Win)
    if sys.platform == 'win32':
        asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())

    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n–ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")