"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ (Telegram ID) –∫ –±–æ—Ç—É.

–ü–æ–∑–≤–æ–ª—è–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –≤—Ä—É—á–Ω—É—é –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ,
–∑–Ω–∞—è –µ–≥–æ `chat_id`. –≠—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥—Ä—É–∑–µ–π, –∫–æ–ª–ª–µ–≥ –∏–ª–∏
—Ç–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –º–æ–≥—É—Ç –∏–ª–∏ –Ω–µ —Ö–æ—Ç—è—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—É—Ç—å
—á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /start –≤ Telegram.

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –Ω–æ –±—ã–ª –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω, —Å–∫—Ä–∏–ø—Ç –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –µ–≥–æ –ø–æ–¥–ø–∏—Å–∫—É.

–ó–∞–ø—É—Å–∫:
    python scripts/manual_sub.py
"""

import asyncio
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ sys.path –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from app.infrastructure.database.session import async_session_factory
from app.infrastructure.database.repositories import BotRepository


async def main() -> None:
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞.

    –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã:
    1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–µ—Å—Å–∏—é –ë–î –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –±–æ—Ç–æ–≤.
    2. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±–æ—Ç–æ–≤.
    3. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID –±–æ—Ç–∞ –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ (chat_id, username).
    4. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–µ—Ç–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è `register_subscriber`, –∫–æ—Ç–æ—Ä—ã–π –∞—Ç–æ–º–∞—Ä–Ω–æ
       –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    print("üë§ –ú–ê–°–¢–ï–† –†–£–ß–ù–û–ô –ü–û–î–ü–ò–°–ö–ò\n")

    async with async_session_factory() as session:
        repo = BotRepository(session)

        # 1. –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–æ—Ç–æ–≤
        # –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å –º–µ—Ç–æ–¥ get_all_active_bots, –Ω–æ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏
        # –ª—É—á—à–µ –≤–∏–¥–µ—Ç—å –í–°–ï–• –±–æ—Ç–æ–≤ (–¥–∞–∂–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö), —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∫ –Ω–∏–º –ø—Ä–∏–≤—è–∑–∞—Ç—å.
        # –ü–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º ORM –∑–∞–ø—Ä–æ—Å –Ω–∞–ø—Ä—è–º—É—é –∏–ª–∏ —Ä–∞—Å—à–∏—Ä—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.
        # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—è, —á—Ç–æ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö.
        bots = await repo.get_all_active_bots()

        if not bots:
            print("‚ùå –í –±–∞–∑–µ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ—Ç–æ–≤. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ –õ–∞—É–Ω—á–µ—Ä.")
            return

        print("--- –î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –±–æ—Ç—ã ---")
        for b in bots:
            print(f"ID [{b.id}]: {b.name} (@{b.token.split(':')[0]}...)")

        # 2. –í—ã–±–æ—Ä –±–æ—Ç–∞
        try:
            bot_id_input = input("\n–í–≤–µ–¥–∏—Ç–µ ID –±–æ—Ç–∞, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ").strip()
            if not bot_id_input.isdigit():
                print("–û—à–∏–±–∫–∞: ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
                return
            bot_id = int(bot_id_input)
        except ValueError:
            print("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–≤–æ–¥.")
            return

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ ID (–ª–æ–∫–∞–ª—å–Ω–∞—è)
        if bot_id not in [b.id for b in bots]:
            print("‚ö†Ô∏è –ë–æ—Ç–∞ —Å —Ç–∞–∫–∏–º ID –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö.")
            return

        # 3. –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            chat_id_input = input("–í–≤–µ–¥–∏—Ç–µ Telegram chat_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á–∏—Å–ª–æ): ").strip()
            if not chat_id_input.isdigit():
                print("–û—à–∏–±–∫–∞: Chat ID –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ —Ü–∏—Ñ—Ä.")
                return
            chat_id = int(chat_id_input)
        except ValueError:
            print("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–≤–æ–¥.")
            return

        username = input("–í–≤–µ–¥–∏—Ç–µ Username (–±–µ–∑ @, –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å): ").strip() or "Manual_Added"

        # 4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        try:
            # –ú–µ—Ç–æ–¥ register_subscriber —Å–∞–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –¥–µ–ª–∞–µ—Ç commit
            is_new = await repo.register_subscriber(bot_id, chat_id, username)

            if is_new:
                print(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} ({chat_id}) —É—Å–ø–µ—à–Ω–æ –î–û–ë–ê–í–õ–ï–ù –∏–ª–∏ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù.")
            else:
                print(f"‚ÑπÔ∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} ({chat_id}) —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∞–∫—Ç–∏–≤–µ–Ω.")

        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –ë–î: {e}")


if __name__ == "__main__":
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è Windows (Python 3.8+)
    if sys.platform == 'win32':
        asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())

    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")