import osimport pandas as pdimport argparseimport loggingfrom typing import get_argsfrom tqdm import tqdmfrom concurrent.futures import ThreadPoolExecutor, as_completedfrom core.backtest_engine import run_backtest_sessionfrom analyzer import BatchTestAnalyzerfrom config import PATH_CONFIG, DATA_FILE_EXTENSION, BACKTEST_CONFIGfrom strategies import AVAILABLE_STRATEGIESfrom core.risk_manager import RiskManagerTypelogging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')logging.getLogger('backtester').setLevel(logging.WARNING)def run_single_test_task(args):    """Задача для выполнения одного бэктеста в отдельном потоке."""    strategy_name, exchange, interval, risk_manager_type, instrument = args    strategy_class = AVAILABLE_STRATEGIES[strategy_name]    # Мы не будем сохранять логи сделок и отчеты для каждого инструмента в batch-режиме,    # чтобы не засорять папки. Оптимизатор будет заниматься этим более осмысленно.    # Цель batch-теста - быстрый прогон и сбор статистики.    backtest_config = {        "strategy_class": strategy_class,        "exchange": exchange,        "instrument": instrument,        "interval": interval,        "risk_manager_type": risk_manager_type,        "initial_capital": BACKTEST_CONFIG["INITIAL_CAPITAL"],        "commission_rate": BACKTEST_CONFIG["COMMISSION_RATE"],        "data_dir": PATH_CONFIG["DATA_DIR"],        "trade_log_path": None,  # Не сохраняем индивидуальные логи    }    results = run_backtest_session(backtest_config)    if results["status"] == "success" and not results["trades_df"].empty:        pnl_percent = (results["total_pnl"] / results["initial_capital"]) * 100        return {            "instrument": instrument,            "pnl_percent": pnl_percent,            "total_trades": len(results["trades_df"])        }    return Nonedef run_batch_test(strategy_name: str, exchange: str, interval: str, risk_manager_type: str, data_dir: str = PATH_CONFIG["DATA_DIR"]):    """    Запускает бэктест указанной стратегии на всех .parquet файлах    в указанной директории данных.    """    logging.info(f"--- Запуск пакетного тестирования для стратегии '{strategy_name}' ---")    # Собираем полный путь к папке с данными для нужного интервала (например, "data/5min")    interval_path = os.path.join(data_dir, exchange, interval)    # Проверяем, существует ли такая папка    if not os.path.isdir(interval_path):        logging.error(f"Ошибка: Директория с данными не найдена: {interval_path}")        return    # Получаем список всех .parquet файлов в директории    data_files = [f for f in os.listdir(interval_path) if f.endswith(DATA_FILE_EXTENSION)]    # Проверяем, нашлись ли вообще файлы для тестирования    if not data_files:        logging.warning(f"В директории {interval_path} не найдено файлов данных (.parquet).")        return    total_files = len(data_files)    logging.info(f"Найдено {total_files} инструментов для тестирования.")    tasks = [(strategy_name, exchange, interval, risk_manager_type, os.path.splitext(f)[0]) for f in data_files]    results_list = []    with ThreadPoolExecutor(max_workers=os.cpu_count()) as executor:        future_to_task = {executor.submit(run_single_test_task, task): task for task in tasks}        for future in tqdm(as_completed(future_to_task), total=len(tasks), desc="Общий прогресс"):            result = future.result()            if result:                results_list.append(result)    if not results_list:        logging.warning("Ни один из бэктестов не произвел сделок.")        return    results_df = pd.DataFrame(results_list)    analyzer = BatchTestAnalyzer(results_df, strategy_name, interval, risk_manager_type)    analyzer.generate_summary_report()    logging.info("\n--- Пакетное тестирование завершено ---")def main():    """    Отвечает за парсинг аргументов и вызов основной логики тестирования.    """    parser = argparse.ArgumentParser(description="Менеджер пакетного тестирования стратегий.")    valid_rms = get_args(RiskManagerType)    parser.add_argument("--strategy", type=str, required=True, help="Имя стратегии для тестирования.")    parser.add_argument("--exchange", type=str, required=True, choices=['tinkoff', 'bybit'],                        help="Биржа для тестирования.")    parser.add_argument("--interval", type=str, required=True, help="Интервал данных.")    parser.add_argument("--rm", dest="risk_manager_type", type=str, default="FIXED", choices=valid_rms,                        help="Модель управления риском.")    args = parser.parse_args()    run_batch_test(args.strategy, args.exchange, args.interval, args.risk_manager_type)if __name__ == "__main__":    main()